
## BabyBilling
> Проект моделирует работу мобильного оператора с микросервисной архитектурой.

---

## Архитектура

Микросервисный проект состоит из 4 сервисов:

| Сервис            | Назначение                                               | Порт |
| ----------------- | -------------------------------------------------------- | ---- |
| **BRT**           | Принимает CDR-записи, сохраняет в БД, передаёт их в HRS  | 8081 |
| **HRS**           | Производит тарификацию звонков, вычисляет списание денег | 8082 |
| **CRM**           | Интерфейс для менеджеров и абонентов через REST API      | 8083 |
| **CDR Generator** | Генерирует случайные звонки и отправляет их в BRT        | 8084 |
| **PostgreSQL**    | Единая база данных для всех сервисов                     | 5432 |

---
## Структура баз данных

### BRT

* `romashka_subscribers` — абоненты: номер, тариф, баланс, дата регистрации, минуты
* `romashka_calls_info` — звонки: номер вызывающего и принимающего, длительность

### HRS

* `tariff_type`, `call_type`, `tariff`, `parameters`, `tariff_parameters` — таблицы для описания тарифов
* Хранение тарифов: классика / помесячная
* Расчёт списания и абонплаты

### CRM

* `crm_manager` — менеджеры CRM (имя, пароль)
* `crm_user` — тестовые абоненты, синхронизируются с BRT

---

## Запуск проекта

```bash
# Собери JAR-файлы
mvn clean package -DskipTests

# Запусти всё в Docker
docker-compose up --build
```

---

## REST API

### CRM

#### Регистрация нового абонента (только менеджер)

```http
POST /api/crm/admin/1234/register
{
  "fullName": "Иван Иванов",
  "phoneNumber": "+79111234567",
  "tariffId": 1
}
```

#### Смена тарифа (только менеджер)

```http
POST /api/crm/admin/1234/change-tariff
{
  "phoneNumber": "+79111234567",
  "newTariffId": 2
}
```

#### Пополнение баланса (менеджер и абонент)

```http
POST /api/crm/admin/1234/refill?phoneNumber=+79111234567&amount=50.0
```

```http
POST /api/crm/+79111234567/refill
{
  "amount": 30.0
}
```

#### Получение информации об абоненте

```http
GET /api/crm/admin/1234/info?phoneNumber=+79111234567
```

---

### CDR Generator

```http
POST /generate/random
```

Создаёт случайные звонки и отправляет их в BRT через RabbitMQ.

---

## Docker

* Каждый микросервис содержит свой `Dockerfile`.
* `docker-compose.yml` запускает PostgreSQL и все сервисы.
* Переменные БД и URL сервисов прокинуты через `application.properties`.

---

## Тарификация

* **Классика**: поминутная оплата входящих/исходящих звонков (Ромашка / не Ромашка)
* **Помесячный тариф**: 50 минут в месяц, после — тарификация по "Классике", списание базовой стоимости каждый месяц с даты регистрации

---

## Liquibase

Каждый сервис использует Liquibase для:

* Автоматического создания таблиц при старте
* Заполнения тестовыми абонентами / тарифами
* Хранения истории миграций
